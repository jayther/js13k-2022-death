<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Death Estate</title>
      <style>
        a,abbr,acronym,address,applet,article,aside,audio,b,big,blockquote,body,canvas,caption,center,cite,code,dd,del,details,dfn,div,dl,dt,em,embed,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hgroup,html,i,iframe,img,ins,kbd,label,legend,li,mark,menu,nav,object,ol,output,p,pre,q,ruby,s,samp,section,small,span,strike,strong,sub,summary,sup,table,tbody,td,tfoot,th,thead,time,tr,tt,u,ul,var,video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section{display:block}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:after,blockquote:before,q:after,q:before{content:'';content:none}table{border-collapse:collapse;border-spacing:0}
      </style>
  </head>
  <body>
      <script>
        !function(){"use strict";const t=Math.PI,e=t=>t<0?-t:t,s=(t,e)=>t<e?t:e,n=(t,e)=>t>e?t:e,i=t=>t<0?-1:1,o=(t,e=0,s=1)=>t<e?e:t>s?s:t,r=(t,e=0,s=1)=>s-e?o((t-e)/(s-e)):0,h=(t=1,e=0)=>e+(t-e)*Math.random(),a=(t=1,e=0)=>0|h(t,e),l=(t=0,e)=>null==t.x?new c(t,null==e?t:e):new c(t.x,t.y);class c{constructor(t=0,e=0){this.x=t,this.y=e}copy(){return new c(this.x,this.y)}add(t){return new c(this.x+t.x,this.y+t.y)}subtract(t){return new c(this.x-t.x,this.y-t.y)}multiply(t){return new c(this.x*t.x,this.y*t.y)}divide(t){return new c(this.x/t.x,this.y/t.y)}scale(t){return new c(this.x*t,this.y*t)}length(){return this.lengthSquared()**.5}lengthSquared(){return this.x**2+this.y**2}distance(t){return this.distanceSquared(t)**.5}distanceSquared(t){return(this.x-t.x)**2+(this.y-t.y)**2}normalize(t=1){const e=this.length();return e?this.scale(t/e):new c(0,t)}clampLength(t=1){const e=this.length();return e>t?this.scale(t/e):this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}angle(){return Math.atan2(this.x,this.y)}setAngle(t=0,e=1){return this.x=e*Math.sin(t),this.y=e*Math.cos(t),this}rotate(t){const e=Math.cos(t),s=Math.sin(t);return new c(this.x*e-this.y*s,this.x*s+this.y*e)}direction(){return e(this.x)>e(this.y)?this.x<0?3:1:this.y<0?2:0}invert(){return new c(this.y,-this.x)}floor(){return new c(Math.floor(this.x),Math.floor(this.y))}area(){return e(this.x*this.y)}lerp(t,e){return this.add(t.subtract(this).scale(o(e)))}arrayCheck(t){return this.x>=0&&this.y>=0&&this.x<t.x&&this.y<t.y}toString(t=3){return`(${(this.x<0?"":" ")+this.x.toFixed(t)},${(this.y<0?"":" ")+this.y.toFixed(t)} )`}}class d{constructor(t=1,e=1,s=1,n=1){this.r=t,this.g=e,this.b=s,this.a=n}copy(){return new d(this.r,this.g,this.b,this.a)}add(t){return new d(this.r+t.r,this.g+t.g,this.b+t.b,this.a+t.a)}subtract(t){return new d(this.r-t.r,this.g-t.g,this.b-t.b,this.a-t.a)}multiply(t){return new d(this.r*t.r,this.g*t.g,this.b*t.b,this.a*t.a)}divide(t){return new d(this.r/t.r,this.g/t.g,this.b/t.b,this.a/t.a)}scale(t,e=t){return new d(this.r*t,this.g*t,this.b*t,this.a*e)}clamp(){return new d(o(this.r),o(this.g),o(this.b),o(this.a))}lerp(t,e){return this.add(t.subtract(this).scale(o(e)))}setHSLA(t=0,e=0,s=1,n=1){const i=s<.5?s*(1+e):s+e-s*e,o=2*s-i,r=(t,e,s)=>(s=(s%1+1)%1)<1/6?t+6*(e-t)*s:s<.5?e:s<2/3?t+(e-t)*(2/3-s)*6:t;return this.r=r(o,i,t+1/3),this.g=r(o,i,t),this.b=r(o,i,t-1/3),this.a=n,this}getHSLA(){const t=this.r,e=this.g,s=this.b,n=this.a,i=Math.max(t,e,s),o=Math.min(t,e,s),r=(i+o)/2;let h=0,a=0;if(i!=o){let n=i-o;a=r>.5?n/(2-i-o):n/(i+o),t==i?h=(e-s)/n+(e<s?6:0):e==i?h=(s-t)/n+2:s==i&&(h=(t-e)/n+4)}return[h/6,a,r,n]}mutate(t=.05,e=0){return new d(this.r+h(t,-t),this.g+h(t,-t),this.b+h(t,-t),this.a+h(e,-e)).clamp()}toString(){return`rgb(${255*this.r|0},${255*this.g|0},${255*this.b|0},${this.a})`}rgbaInt(){return(255*this.r|0)+(255*this.g<<8)+(255*this.b<<16)+(255*this.a<<24)}setHex(t){const e=e=>parseInt(t.slice(e,e+2),16)/255;return this.r=e(1),this.g=e(3),this.b=e(5),this.a=1,this}getHex(){const t=t=>((t=255*t|0)<16?"0":"")+t.toString(16);return"#"+t(this.r)+t(this.g)+t(this.b)}}let u=l(1920,1200),p=l(),y=l(16),g=.3,f=(l(1),l()),x=n(y.x,y.y);let m=.5;let w,b,v=[],S=[],C=0,M=0,T=0,z=0,B=0;const P="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)";function R(){S=v.filter((t=>t.collideSolidObjects));const t=e=>{if(!e.destroyed){e.update();for(const s of e.children)t(s)}};for(const e of v)e.parent||t(e);v=v.filter((t=>!t.destroyed)),M=++C/60}const F=new Image;let k,A,E,D,I=l();const L=t=>t.add(l(.5)).subtract(I.scale(.5)).multiply(l(1/x,-1/x)).add(f),W=t=>t.subtract(f).multiply(l(x,-x)).add(I.scale(.5)).subtract(l(.5));function H(t,e=l(1),s=-1,n=y,i=new d,o=0,r,h=new d(0,0,0,0),a=1){if(a)if(s<0||!F.width)Ct(t.x,t.y,e.x,e.y,o,0,0,0,0,0,i.rgbaInt());else{const a=w.x/n.x|0,l=n.x/w.x,c=n.y/w.y,d=s%a*l,u=(s/a|0)*c;Ct(t.x,t.y,r?-e.x:e.x,e.y,o,d+b.x,u+b.y,d-b.x+l,u-b.y+c,i.rgbaInt(),h.rgbaInt())}else!function(t,e,s,n,i,o=A){t=W(t),e=e.scale(x),o.save(),o.translate(t.x+.5|0,t.y-.5|0),o.rotate(s),o.scale(n?-e.x:e.x,e.y),i(o),o.restore()}(t,e,o,r,(t=>{if(s<0)t.fillStyle=i,t.fillRect(-.5,-.5,1,1);else{const e=w.x/n.x|0,o=s%e*n.x+g,r=(s/e|0)*n.y+g,h=n.x-.6,a=n.y-.6;t.globalAlpha=i.a,t.drawImage(F,o,r,h,a,-.5,-.5,1,1)}}))}function $(t,e,s,n,i){H(t,e,-1,y,s,n,0,0,i)}function G(t,e,s,n,i){!function(t,e=l(1),s,n,i,o,r,h,a){H(L(t),e.scale(1/x),s,n,i,o,r,h,a)}(t,e,-1,y,s,n,0,0,i)}function U(t,e,s=1,n=new d,i=0,o=new d(0,0,0),r="center",h="arial"){D.fillStyle=n,D.lineWidth=i,D.strokeStyle=o,D.textAlign=r,D.font=s+"px "+h,D.textBaseline="middle",D.lineJoin="round",e=e.copy(),(t+"").split("\n").forEach((t=>{i&&D.strokeText(t,e.x,e.y),D.fillText(t,e.x,e.y),e.y+=s}))}function _(t,e,s=1,n,i,o,r,h){U(t,W(e),s*x,n,i*x,o,r,h)}const q=(t,e=0)=>Q[e]&&1&Q[e][t]?1:0,O=q,N=(t,e=0)=>Q[e]&&2&Q[e][t]?1:0,J=(t,e=0)=>Q[e]&&4&Q[e][t]?1:0;let Y=l(),j=l(),K=0,V=0;const X=(t,e=0)=>q(t,e+1);let Q=[[]];function Z(){document.hasFocus()||(Q=[[]]),Y=L(j),function(){0;if(!navigator.getGamepads||!document.hasFocus())return;const t=navigator.getGamepads();for(let e=t.length;e--;){const s=t[e],n=Q[e+1]||(Q[e+1]=[]),i=nt[e]||(nt[e]=[]);if(s){const t=.3,o=.8,h=e=>e>t?r(e,t,o):e<-t?-r(-e,t,o):0;for(let t=0;t<s.axes.length-1;t+=2)i[t>>1]=l(h(s.axes[t]),h(-s.axes[t+1])).clampLength();for(let t=s.buttons.length;t--;){const i=s.buttons[t];n[t]=i.pressed?1+2*!X(t,e):4*X(t,e),V|=!e&&i.pressed}{const t=l(X(15,e)-X(14,e),X(12,e)-X(13,e));t.lengthSquared()&&(i[0]=t.clampLength())}}}}()}function tt(){for(const t of Q)for(const e in t)t[e]&=1;K=0}onkeydown=t=>{t.repeat||(Q[V=0][et(t.keyCode)]=3)},onkeyup=t=>{Q[0][et(t.keyCode)]=4};const et=t=>87==t?38:83==t?40:65==t?37:68==t?39:t;onmousedown=t=>{Q[V=0][t.button]=3,onmousemove(t),t.button&&t.preventDefault()},onmouseup=t=>Q[0][t.button]=2&Q[0][t.button]|4,onmousemove=t=>j=st(t),onwheel=t=>t.ctrlKey||(K=i(t.deltaY)),oncontextmenu=t=>!1;const st=t=>{if(!k)return l();const e=k.getBoundingClientRect();return l(k.width,k.height).multiply(l(r(t.x,e.left,e.right),r(t.y,e.top,e.bottom)))},nt=[];const it=void 0!==window.ontouchstart;if(it){let t,e;ontouchstart=ontouchmove=ontouchend=s=>{s.button=0;const n=s.touches.length;return n?(e||rt(0,e=1),s.x=s.touches[0].clientX,s.y=s.touches[0].clientY,t?onmousemove(s):onmousedown(s)):t&&onmouseup(s),t=n,!s.cancelable}}let ot;new class{constructor(t){this.time=null==t?void 0:M+t,this.setTime=t}set(t=0){this.time=M+t,this.setTime=t}unset(){this.time=void 0}isSet(){return null!=this.time}active(){return M<=this.time}elapsed(){return M>this.time}get(){return this.isSet()?M-this.time:0}getPercent(){return this.isSet()?r(this.time-M,this.setTime,0):0}toString(){0}},l();const rt=(...t)=>function(t,e=1,s=1,n=0,i=0){if(ot||(ot=new(window.AudioContext||webkitAudioContext)),ot.resume(),"running"!=ot.state)return;const r=ot.createBuffer(t.length,t[0].length,ht),h=ot.createBufferSource();t.forEach(((t,e)=>r.getChannelData(e).set(t))),h.buffer=r,h.playbackRate.value=s,h.loop=i;const a=ot.createGain();return a.gain.value=.5*e,a.connect(ot.destination),(window.StereoPannerNode?h.connect(new StereoPannerNode(ot,{pan:o(n,-1,1)})):h).connect(a),h.start(),h}([at(...t)]),ht=44100;function at(o=1,r=.05,a=220,l=0,c=0,d=.1,u=0,p=1,y=0,g=0,f=0,x=0,m=0,w=0,b=0,v=0,S=0,C=1,M=0,T=0){let z,B,P=2*t,R=y*=500*P/ht/ht,F=[],k=a*=(1+r*h(-1,1))*P/ht,A=0,E=0,D=0,I=1,L=0,W=0,H=0;for(g*=500*P/ht**3,b*=P/ht,f*=P/ht,x*=ht,m=m*ht|0,B=(l=l*ht+9)+(M*=ht)+(c*=ht)+(d*=ht)+(S*=ht)|0;D<B;F[D++]=H)++W%(100*v|0)||(H=u?u>1?u>2?u>3?Math.sin((A%P)**3):n(s(Math.tan(A),1),-1):1-(2*A/P%2+2)%2:1-4*e(Math.round(A/P)-A/P):Math.sin(A),H=(m?1-T+T*Math.sin(P*D/m):1)*i(H)*e(H)**p*o*.5*(D<l?D/l:D<l+M?1-(D-l)/M*(1-C):D<l+M+c?C:D<B-S?(B-D-S)/d*C:0),H=S?H/2+(S>D?0:(D<B-S?1:(B-D)/S)*F[D-S|0]/2):H),z=(a+=y+=g)*Math.cos(b*E++),A+=z-z*w*(1-1e9*(Math.sin(D)+1)%2),I&&++I>x&&(a+=f,k+=f,I=0),!m||++L%m||(a=k,y=R,I=I||1);return F}l();let lt,ct,dt,ut,pt,yt,gt,ft,xt,mt,wt,bt=[];function vt(t,e){const s=dt.createShader(e);return dt.shaderSource(s,t),dt.compileShader(s),s}function St(){if(!xt)return;const t=mt?Mt:Bt;dt.blendFuncSeparate(zt,t,Mt,t),dt.enable(Pt),dt.bufferSubData(Gt,0,gt.subarray(0,xt*Ot*Nt)),dt.drawArrays(Tt,0,xt*Ot),xt=0,mt=wt}function Ct(t,e,s,n,i,o,r,h,a,l=4294967295,c=0){xt!=Jt&&mt==wt||St();const d=Math.cos(i)/2,u=Math.sin(i)/2,p=d*s,y=d*n,g=u*s,f=u*n;let x=xt++*Ot*Nt;gt[x++]=t-p-f,gt[x++]=e-y+g,gt[x++]=o,gt[x++]=a,ft[x++]=l,ft[x++]=c,gt[x++]=t+p+f,gt[x++]=e+y-g,gt[x++]=h,gt[x++]=r,ft[x++]=l,ft[x++]=c,gt[x++]=t-p+f,gt[x++]=e+y+g,gt[x++]=o,gt[x++]=r,ft[x++]=l,ft[x++]=c,gt[x++]=t-p-f,gt[x++]=e-y+g,gt[x++]=o,gt[x++]=a,ft[x++]=l,ft[x++]=c,gt[x++]=t+p-f,gt[x++]=e-y-g,gt[x++]=h,gt[x++]=a,ft[x++]=l,ft[x++]=c,gt[x++]=t+p+f,gt[x++]=e+y-g,gt[x++]=h,gt[x++]=r,ft[x++]=l,ft[x++]=c}const Mt=1,Tt=4,zt=770,Bt=771,Pt=3042,Rt=3553,Ft=5121,kt=5126,At=6408,Et=9728,Dt=10240,It=10241,Lt=10242,Wt=10243,Ht=16384,$t=33071,Gt=34962,Ut=35048,_t=35632,qt=35633,Ot=6,Nt=6,Jt=65536,Yt=24,jt=0,Kt=1,Vt=2,Xt=3,Qt=4,Zt=5,te=0,ee=1,se=2,ne=3,ie=[[0,1],[1,0],[0,-1],[-1,0]],oe=0,re=1,he=2,ae=3,le=4;class ce{constructor(){this.buttons=[],this.pressedButton=null}addBtn(t){this.buttons.push(t)}removeBtn(t){const e=this.buttons.indexOf(t);e>-1&&this.buttons.splice(e,1)}pressed(){this.pressedButton=null;for(let t=this.buttons.length-1;t>=0&&!this.pressedButton;t--){const e=this.buttons[t];e.containsMousePos()&&(this.pressedButton=e)}return!!this.pressedButton}released(){return!!this.pressedButton&&(this.pressedButton.containsMousePos()&&this.pressedButton.pressed(),this.pressedButton=null,!0)}render(){this.buttons.forEach((t=>t.render()))}}class de{constructor(t,e,s,n,i,o,r,h=!0){this.pos=t,this.size=e,this.text=s,this.textSize=n,this.bgColor=i,this.textColor=o,this.onPressed=r||(()=>{}),this._enabled=!0,this.visible=!0,this.screenSpace=h}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this.bgColor.a=t?1:.5,this.textColor.a=t?1:.5}containsMousePos(){if(!this.enabled||!this.visible)return!1;const t=this.screenSpace?j:Y;return t.x>=this.pos.x-this.size.x/2&&t.y>=this.pos.y-this.size.y/2&&t.x<this.pos.x+this.size.x/2&&t.y<this.pos.y+this.size.y/2}pressed(){this.onPressed()}render(){if(!this.visible)return;let t,e;this.screenSpace?(t=G,e=U):(t=$,e=_),t(this.pos,this.size,this.bgColor),e(this.text,this.pos,this.textSize,this.textColor)}}const ue=new class{constructor(){this.controllerMap=null,this.gameState=oe}init(t){this.controllerMap=t}setGameState(t,e){this.gameState=t,this.curController=this.controllerMap[t],this.curController.init(e)}gameUpdate(){this.curController.gameUpdate()}gameRender(){this.curController.gameRender()}},pe=l(0,4),ye=new d(1,0,0),ge=new d(1,1,1),fe=new de(l(0,-2),l(4,2.5),"Start",1.5,new d(1,1,1),new d(0,0,0),(()=>{ue.setGameState(he)}),!1),xe=new ce;xe.addBtn(fe);const me={init(){},gameUpdate(){N(0)&&xe.pressed(),J(0)&&xe.released()},gameRender(){_("Death Estate",pe,5,ye,h(1,1.2),ge),xe.render()}},we=[null,null,new d(.6,.6,.6),new d(.5,.5,.5),new d(.8,.3,.3),new d(1,0,0)],be=[new d(.3,.3,.3),new d(.35,.35,.35)];class ve{constructor(t,e,s){this.x=e,this.y=s,this.type=t||0}copy(){return new ve(this.type,this.x,this.y)}apply(t){this.type=t.type}}class Se{constructor(t,e){this.pos=l(),this.tiles=[],this.houses=[],this.snapshotTiles=[],this.allRoadsConnected=!1,this.size=l(t,e);const s=this.size.x*this.size.y;for(let t=0;t<s;t+=1){const e=new ve(0,t%this.size.x,Math.floor(t/this.size.y));this.tiles.push(e),this.snapshotTiles.push(e.copy())}}createSnapshot(){this.tiles.forEach(((t,e)=>this.snapshotTiles[e].apply(t)))}houseCanFit(t){const e=t.getWorldBounds(),s=this.getWorldBounds();if(!(e[0].x>=s[0].x&&e[0].y>=s[0].y&&e[1].x<=s[1].x&&e[1].y<=s[1].y))return!1;const n=t.pos.divide(l(2)),i=t.tiles;for(let t=0;t<i.length;t+=1){const e=i[t];for(let s=0;s<e.length;s+=1){if(!e[s])continue;const i=n.add(l(s,t));if(this.getTile(i.x,i.y).type)return!1}}return!0}houseFitsSomewhere(t){const e=t.copy();e.state=ne;for(const t of this.tiles){const s=l(t.x,t.y).multiply(l(2));e.pos=s;for(let t=0;t<4;t++){if(this.houseCanFit(e)&&this.houseIsTouchingRoad(e))return e;e.rotate(1)}}return null}houseIsTouchingRoad(t){const e=t.pos.divide(l(2)),s=t.tiles;for(let t=0;t<s.length;t+=1){const n=s[t];for(let s=0;s<n.length;s+=1){if(!n[s])continue;const i=e.add(l(s,t));if(ie.map((t=>this.getTile(i.x+t[0],i.y+t[1]))).filter((t=>t)).some((t=>t.type===Vt)))return!0}}return!1}addHouse(t){t.state=ee,this.houses.push(t);const e=t.pos.divide(l(2)),s=t.tiles;for(let t=0;t<s.length;t+=1){const n=s[t];for(let s=0;s<n.length;s+=1){if(!n[s])continue;const i=e.add(l(s,t));this.setTile(i.x,i.y,Kt)}}}getWorldSize(){return this.size.multiply(l(2))}getWorldBounds(){return[this.pos.copy(),this.pos.add(this.size.multiply(l(2)))]}setTile(t,e,s){this.tiles[t+e*this.size.x].type=s}getTile(t,e){return this.tiles[t+e*this.size.x]}getTileFromMousePos(){const t=this.getCoordsFromMousePos();return t?this.getTile(t.x,t.y):null}getCoordsFromMousePos(t=!1){return this.getCoordsFromPos(Y,t)}getCoordsFromPos(t,e=!1){const s=t.subtract(this.pos).add(l(1));if(!e){if(s.x<0)return null;if(s.x>=2*this.size.x)return null;if(s.y<0)return null;if(s.y>=2*this.size.y)return null}return s.divide(l(2)).floor()}setTileLine(t,e,s){const n=[];if(Math.abs(e.x-t.x)<Math.abs(e.y-t.y)){const s=Math.max(Math.min(e.y,t.y),0),i=Math.min(Math.max(e.y,t.y),this.size.y-1);for(let e=s;e<=i;e+=1)n.push(this.getTile(t.x,e))}else{const s=Math.max(Math.min(e.x,t.x),0),i=Math.min(Math.max(e.x,t.x),this.size.x-1);for(let e=s;e<=i;e+=1)n.push(this.getTile(e,t.y))}for(const t of n)t.type=s;return n}resetToSnapshot(){this.tiles.forEach(((t,e)=>t.apply(this.snapshotTiles[e])))}checkRoadConnection(){const t=this.tiles.filter((t=>t.type===Vt||t.type===Zt));t.forEach((t=>t.type=Zt));const e=t.filter((t=>0===t.x||0===t.y||t.x===this.size.x-1||t.y===this.size.y-1));e.length?(e.forEach((t=>this.setConnectedRoads(t.x,t.y))),this.allRoadsConnected=t.every((t=>t.type===Vt))):this.allRoadsConnected=!1}setConnectedRoads(t,e){const s=this.getTile(t,e);if(s&&s.type===Zt){s.type=Vt;for(const s of ie)this.setConnectedRoads(t+s[0],e+s[1])}}getCounts(){const t=this.size.x*this.size.y;let e=0,s=0;for(const t of this.tiles)t.type===Kt?e+=1:t.type===Vt&&(s+=1);return{totalCount:t,houseTileCount:e,roadCount:s}}render(){for(let t=0;t<this.size.y;t+=1)for(let e=0;e<this.size.x;e+=1){const s=l(e,t).multiply(l(2)).add(this.pos),n=this.getTile(e,t),i=we[n.type]||be[(e+t)%2];i&&$(s,l(2),i)}for(const t of this.houses)t.render()}}const Ce=[new d,new d(.9,.9,.9),new d(1,.3,.3),new d(1,1,1,.5)];class Me{constructor(t,e){this.pos=t,this.tiles=e||function(t){const e=2*t-1,s=a(1,e**2+1),n=[],i=[];for(let t=0;t<e;t++)n.push(new Array(e).fill(jt));for(let t=0;t<s;t++){let s,o;if(0===t)s=a(0,e),o=a(0,e),i.push([s,o]);else{const t=i[a(0,i.length)],r=ie.map((s=>{let i=[t[0]+s[0],t[1]+s[1]];return i[0]<0||i[0]>=e||i[1]<0||i[1]>=e||n[i[1]][i[0]]!==jt?null:i})).filter((t=>t));if(!r.length)continue;const h=r[a(0,r.length)];[s,o]=h,i.push(h)}n[o][s]=Kt}for(let t=n.length-1;t>=0;t--)n[t].every((t=>t===jt))&&n.splice(t,1);for(let t=e-1;t>=0;t--)n.map((e=>e[t])).every((t=>t===jt))&&n.forEach((e=>e.splice(t,1)));return n}(2),this.state=te}copy(){const t=[];for(let e=0;e<this.tiles.length;e++)t.push([...this.tiles[e]]);return new Me(this.pos.copy(),t)}getWorldBounds(){const t=2*this.tiles[0].length,e=2*this.tiles.length;return[this.pos.copy(),this.pos.add(l(t,e))]}isClicked(){const t=Y.subtract(this.pos).add(l(1)).divide(l(2)).floor(),e=this.tiles[t.y];return!!e&&!!e[t.x]}rotate(t){const e=this.tiles.length,s=this.tiles[0].length,n=new Array(s);for(let t=0;t<s;t++)n[t]=new Array(e).fill(jt);for(let t=0;t<e;t++)for(let e=0;e<s;e++)n[e][t]=this.tiles[t][e];1===t?n.reverse():n.forEach((t=>t.reverse())),this.tiles=n}render(){for(let t=0;t<this.tiles.length;t+=1){const e=this.tiles[t];for(let s=0;s<e.length;s+=1){if(!e[s])continue;const n=Ce[this.state]||new d(1,0,0);$(l(s,t).multiply(l(2)).add(this.pos),l(2),n)}}}}let Te,ze,Be,Pe,Re,Fe=l(),ke=l(),Ae=!1,Ee=null,De=l();const Ie=l(),Le=l(),We=new ce,He=new de(l(0,-4),l(5,3),"Done",1.5,new d(1,1,1),new d(0,0,0),(()=>{Te.allRoadsConnected&&ue.setGameState(ae)}),!1);We.addBtn(He);const $e=new ce,Ge=new de(l(0,-5),l(5,3),"Rotate",1.2,new d(1,1,1),new d(0,0,0),(()=>{Pe.rotate(1)}),!1);$e.addBtn(Ge);const Ue=new de(Ge.pos.add(l(0,-4)),l(5,3),"Skip",1.5,new d(1,1,1),new d(0,0,0),(()=>{Be>0&&(Be-=1,Je()),Be<=0&&(Ue.enabled=!1,_e.enabled=!0)}),!1);$e.addBtn(Ue);const _e=new de(Ue.pos.add(l(0,-4)),l(5,3),"End",1.5,new d(1,1,1),new d(0,0,0),(()=>{const t=Te.getCounts();ue.setGameState(le,{timestamp:Date.now(),totalMaxScore:t.totalCount,score:t.houseTileCount,roadCount:t.roadCount})}),!1);$e.addBtn(_e);const qe={lower:l(),upper:l()},Oe=_e.pos.subtract(_e.size.divide(l(2))).add(l(1)),Ne=Ge.pos.add(Ge.size.divide(l(2))).add(l(1));function Je(){Pe=new Me(De.copy()),Re=Te.houseFitsSomewhere(Pe),console.log("houseFitsSomewhere",!!Re)}const Ye={init(){Te=new Se(15,15),Ae=!1,Ee=null;const t=Te.getWorldSize();f.x=Te.pos.x+t.x/2-1,f.y=Te.pos.y+t.y/2-1,He.pos.x=Te.pos.x+t.x/2-1,He.enabled=!1,Ie.x=He.pos.x,Ie.y=Te.pos.y+t.y-1+5,Le.x=He.pos.x,Le.y=He.pos.y-4},gameUpdate(){if(N(0)){if(!We.pressed()&&(Ee=Te.getCoordsFromMousePos(),Ee)){Te.createSnapshot();const t=Te.getTileFromMousePos();ze=t.type===Vt||t.type===Zt?Qt:Xt}}if(J(0)){if(We.released(),Ee){Te.resetToSnapshot();const t=Te.getCoordsFromMousePos(!0);ze===Xt?Te.setTileLine(Ee,t,Vt):Te.setTileLine(Ee,t,jt),Te.checkRoadConnection(),He.enabled=Te.allRoadsConnected}Ee=null}if(O(0)&&Ee){Te.resetToSnapshot();const t=Te.getCoordsFromMousePos(!0);Te.setTileLine(Ee,t,ze)}},gameRender(){Te.render(),_("Make roads by clicking and dragging lines\non the grid. Delete by clicking and dragging\non existing roads",Ie,1.5),Te.allRoadsConnected||_("All roads must connect to an edge of the grid",Le,1.5),We.render()}},je={init(){const t=Te.getWorldSize();De.x=Te.pos.x+t.x/2-1,De.y=-8,Be=3,Ue.enabled=!0,_e.enabled=!1;const e=Te.getWorldBounds();qe.lower=e[0].subtract(l(8)),qe.upper=e[1].add(l(8)),Je()},gameUpdate(){if(J(2)&&Pe.rotate(1),N(0)){!$e.pressed()&&Pe.isClicked()&&(Pe.state=te,Fe=Pe.pos.copy(),ke=Y.copy(),Ae=!0)}if(J(0)&&($e.released(),Ae)){Pe.pos.x=2*Math.floor((Pe.pos.x+1)/2),Pe.pos.y=2*Math.floor((Pe.pos.y+1)/2);const t=Pe.getWorldBounds(),e=l((t[0].x+t[1].x)/2,(t[0].y+t[1].y)/2);e.x>=Oe.x&&e.x<=Ne.x&&e.y>=Oe.y&&e.y<=Ne.y&&(Pe.pos.x=Fe.x,Pe.pos.y=Fe.y),Te.houseCanFit(Pe)&&Te.houseIsTouchingRoad(Pe)?(Te.addHouse(Pe),Je()):Pe.state=se,Ae=!1}if(O(0)&&Ae){Pe.pos.x=Fe.x+(Y.x-ke.x),Pe.pos.y=Fe.y+(Y.y-ke.y);const t=Pe.getWorldBounds();t[0].x<qe.lower.x?Pe.pos.x=qe.lower.x:t[1].x>qe.upper.x&&(Pe.pos.x=qe.upper.x-(t[1].x-t[0].x)),t[0].y<qe.lower.y?Pe.pos.y=qe.lower.y:t[1].y>qe.upper.y&&(Pe.pos.y=qe.upper.y-(t[1].y-t[0].y))}},gameRender(){Te.render(),Pe.render(),Re&&Re.render(),_("Place houses! Must touch a road, not overlap\nother houses, and be within the grid",Ie,1.5),_("right-click\nworks too",Ge.pos.add(l(3,.5)),1,void 0,void 0,void 0,"left"),_(`Skips left: ${Be}`,Ue.pos.add(l(3,0)),1.5,void 0,void 0,void 0,"left"),$e.render()}},Ke=new d(1,0,0),Ve=new d(1,1,1),Xe=new d(1,1,1),Qe=new d(1,1,0),Ze="deathestate_jayther_ldb",ts={};let es,ss=[],ns=0,is=0,os=!0;const rs=l(0,18),hs=rs.add(l(0,-5)),as=rs.add(l(0,-13)),ls=as.add(l(3,-5)),cs=new Array(5);for(let t=0;t<cs.length;t++)cs[t]=[ls.add(l(-.7,-2*t)),ls.add(l(.7,-2*t))];const ds=new ce,us=new de(rs.add(l(0,-31)),l(5,3),"Retry",1.5,new d(1,1,1),new d(0,0,0),(()=>{ue.setGameState(he)}),!1);function ps(t,e){for(es={score:t,timestamp:e,dateStr:new Date(e).toLocaleDateString(),current:!0},ss.push(es),ss.sort(((t,e)=>{const s=e.score-t.score;return 0===s?e.timestamp-t.timestamp:s}));ss.length>5;)ss.pop();!function(){const t=ss.map((t=>({score:t.score,timestamp:t.timestamp}))),e=JSON.stringify(t);if(os)try{window.localStorage.setItem(Ze,e)}catch(t){os=!1}os||(ts[Ze]=e)}()}ds.addBtn(us);const ys=[{init(){},gameUpdate(){},gameRender(){}},me,Ye,je,{init(t){ns=t.totalMaxScore,is=t.roadCount,function(){let t=null;if(os)try{t=window.localStorage.getItem(Ze)}catch(t){os=!1}else t=ts[Ze]||null;t&&(ss=JSON.parse(t)),ss.forEach((t=>t.dateStr=new Date(t.timestamp).toLocaleDateString()))}(),ps(t.score,t.timestamp),f.x=0,f.y=0},gameUpdate(){N(0)&&ds.pressed(),J(0)&&ds.released()},gameRender(){!function(){_("Game over",rs,4,Ke,.5,Ve),_(`You covered ${es.score} tiles (${Math.floor(es.score/ns*100)}%)\n(road count: ${is}, grid total: ${ns})`,hs,2,Xe),_("High Scores",as,4,Ke,.5,Ve);for(let t=0;t<5;t++){const e=ss[t];let s,n,i;e?(s=e.dateStr,n=e.score.toString(),i=e.current?Qe:Xe):(s="-------------",n="---",i=Xe),_(s,cs[t][0],2,i,void 0,void 0,"right"),_(n,cs[t][1],2,i,void 0,void 0,"left")}}(),ds.render()}}],gs=680,fs=940,xs=x;!function(t,e,n,i,o,r){F.onerror=F.onload=()=>{b=l(g).divide(w=l(F.width,F.height)),document.body.style="margin:0;overflow:hidden;background:#000;touch-action:none;user-select:none;-webkit-user-select:none;-moz-user-select:none",document.body.appendChild(k=document.createElement("canvas")),A=k.getContext("2d"),k.style=P,function(){0;ct=document.createElement("canvas"),dt=ct.getContext("webgl",{antialias:!1}),ct.style=P,ut=function(t){if(!t||!t.width)return;const e=dt.createTexture();return dt.bindTexture(Rt,e),dt.texImage2D(Rt,0,At,At,Ft,t),dt.texParameteri(Rt,It,Et),dt.texParameteri(Rt,Dt,Et),dt.texParameteri(Rt,Lt,$t),dt.texParameteri(Rt,Wt,$t),e}(F),document.body.appendChild(ct),yt=function(t,e){0;const s=dt.createProgram();dt.attachShader(s,vt(t,qt)),dt.attachShader(s,vt(e,_t)),dt.linkProgram(s),0;return s}("precision highp float;uniform mat4 m;attribute vec2 p,t;attribute vec4 c,a;varying vec2 v;varying vec4 d,e;void main(){gl_Position=m*vec4(p,1,1);v=t;d=c;e=a;}","precision highp float;varying vec2 v;varying vec4 d,e;uniform sampler2D s;void main(){gl_FragColor=texture2D(s,v)*d+e;}");const t=new ArrayBuffer(Jt*Ot*Yt);(function(t,e,s){0;const n=dt.createBuffer();dt.bindBuffer(t,n),dt.bufferData(t,e,s)})(Gt,t.byteLength,Ut),gt=new Float32Array(t),ft=new Uint32Array(t);let e=xt=0;const s=(t,s,n,i,o=0)=>{const r=dt.getAttribLocation(yt,t);dt.enableVertexAttribArray(r),dt.vertexAttribPointer(r,i,s,o,Yt,e),e+=i*n};s("p",kt,4,2),s("t",kt,4,2),s("c",Ft,1,4,1),s("a",Ft,1,4,1)}(),document.body.appendChild(E=document.createElement("canvas")),D=E.getContext("2d"),E.style=P,t(),h()};const h=(t=0)=>{let r=t-z;if(z=t,T+=r/1e3,B=s(B+!0*r,50),p.x){E.width=k.width=p.x,E.height=k.height=p.y;const t=innerWidth/innerHeight,e=k.width/k.height;k.style.width=E.style.width=t<e?"100%":"",k.style.height=E.style.height=t<e?"":"100%",ct&&(ct.style.width=k.style.width,ct.style.height=k.style.height)}else E.width=k.width=s(innerWidth,u.x),E.height=k.height=s(innerHeight,u.y);I=l(k.width,k.height);{let t=0;for(B<0&&B>-9&&(t=B,B=0);B>=0;B-=1e3/60)Z(),e(),R(),n(),tt();B+=t}I=l(k.width,k.height),A.imageSmoothingEnabled=!1,function(t,e,s,n,i){var o;dt.viewport(0,0,ct.width=t,ct.height=e),dt.clear(Ht),dt.bindTexture(Rt,pt=ut),dt.useProgram(yt),wt=o;const r=2*i/t,h=2*i/e;dt.uniformMatrix4fv(dt.getUniformLocation(yt,"m"),0,new Float32Array([r,0,0,0,0,h,0,0,1,1,-1,1,-1-r*s,-1-h*n,0,0]))}(k.width,k.height,f.x,f.y,x),i(),v.sort(((t,e)=>t.renderOrder-e.renderOrder));for(const t of v)t.destroyed||t.render();o(),function(){if(!bt.length)return;const t=bt[0],e=T-lt;if(lt)if(e>5)bt.shift(lt=0);else{const s=4.5,n=e<m?1-e/m:e>s?(e-s)/m:0;t.render(n)}else lt=T}(),function(t,e){if(!xt&&!e)return;St(),e&&t.drawImage(ct,0,0)}(A),requestAnimationFrame(h)};r?F.src=r:F.onload()}((function(){ws(),ue.init(ys),ue.setGameState(re)}),(function(){ue.gameUpdate()}),(function(){}),(function(){ue.gameRender()}),(function(){}));let ms=null;function ws(){const t=gs/fs>innerWidth/innerHeight?innerWidth/gs:innerHeight/fs;!function(t){x=t}(xs*t)}window.addEventListener("resize",(function(){clearTimeout(ms),ms=setTimeout(ws,200)}),!1)}();
      </script>
  </body>
</html>
